unit ulibSettings;

interface
uses
  IniFiles, SysUtils, uIniFilesProcs, uCodecBase64;
const
  c_image = 'image';
type
  TPathImageSetting = record
    ImgPath: string;
  end;

  TRecBridgeDB  = record
    mDBServer,
    mDBProto,
    mDBName,
    mDBUser,
    mDBPass,
    mDBPort: string
  end;

  TRecBridgeServer  = record
    m2D_IP,
    m2D_Port,
    m3D_IP,
    m3D_Port,
    mCtrl_IP,
    mCtrl_port : string;
  end;


  function getFileSetting: string;
  function LoadFF_PathImageSetting(const fName: string; var imgSet: TPathImageSetting): boolean;
  procedure InitDefault_DBConfig(
    const Path: string;
      var mDBServer, mDBProto, mDBName, mDBUser,  mDBPass, mDBPort : string
    );

const
  iniBridgeSet        = 'BridgeSet.ini';
  defaultServer       = 'localhost';
  default3DServer     = '192.168.0.82';
  defaultServerPort   = '2120';
  default3DServerPort = '5001';

  default2DServerPortConverter = '7001';
  default3DServerPortConverter = '7002';

  defaultDBServer   = '192.168.1.141';
  defaultDBProto    = 'mysql';
  defaultDBName     = 'dbNSuFs';
  defaultDBUser     = 'usrNSUFS';
  defaultDBPassword = 'admin';
  defaultDBPort     = '3306';

  iniSectDBConfig = 'DBCONFIG';
  iniValDBServer  = 'DBSERVER';
  iniValDBProto   = 'DBPROTO';
  iniValDBName    = 'DBNAME';
  iniValDBUser    = 'DBUSER';
  iniValDBpass    = 'DBPASS';
  iniValDBport    = 'DBPORT';

var
  {global var}
  //loaded setting  FROM FILE

  vSettingFile: string;
  vPathImageSetting      : TPathImageSetting;

implementation
  //==============================================================================
  function getFileSetting: string;
  begin
  //  result := ChangeFileExt(ParamStr(0), '.ini');
    result := ExtractFilePath(ParamStr(0)) + 'm57setting.ini';
  end;
  //==============================================================================

  function LoadFF_PathImageSetting(const fName: string; var imgSet: TPathImageSetting): boolean;
  var
    IniF: TIniFile;
    s: string;
  begin
    IniF := TIniFile.Create(fName);
    s := ExtractFilePath(ParamStr(0));

    with imgSet do
    begin
      ImgPath := IncludeTrailingBackslash(s + IniFReadstring(IniF, c_image,
        'imgpath', '.\data\Picture\'));
    end;

    Result := True;
  end;

  function ForceReadString(var ini : TIniFile;
  const sSect, sKey, sDefault : string): string;
  begin
    result := ini.ReadString(sSect, sKey, '');
    if result = '' then begin
      result := sDefault;
      ini.WriteString(sSect, sKey, sDefault);
    end;

  end;

  procedure InitDefault_DBConfig(
    const Path: string;
      var mDBServer, mDBProto, mDBName, mDBUser,  mDBPass, mDBPort : string
    );
  var
    ini: TIniFile;
    readIn, readOut, iniF: string;
  begin
    ini := TIniFile.Create(vSettingFile);

    mDBServer := ForceReadString(ini, iniSectDBConfig, iniValDBServer, defaultDBServer);
    mDBProto := ForceReadString(ini, iniSectDBConfig, iniValDBProto, defaultDBProto);

    readIn := Base64Encode(defaultDBName);
    readOut := ForceReadString(ini, iniSectDBConfig, iniValDBName, readIn);
    mDBName := Base64Decode(readOut);

    readIn := Base64Encode(defaultDBUser);
    readOut := ForceReadString(ini, iniSectDBConfig, iniValDBUser, readIn);
    mDBUser := Base64Decode(readOut);

    readIn := Base64Encode(defaultDBPassword);
    readOut := ForceReadString(ini, iniSectDBConfig, iniValDBPass, readIn);
    mDBPass := Base64Decode(readOut);

    mDBPort := ForceReadString(ini, iniSectDBConfig, iniValDBport, defaultDBPort);

    ini.Free;
  end;
end.
